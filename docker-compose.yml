name: zkit

networks:
    frontend:
        driver: ${NETWORKS_DRIVER}

services:
    #### Api Gateway service ###########################################
    api_gateway:
        container_name: zkit_api_gateway
        build:
            context: ./api_gateway
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${APP_PORT}:8000"
        volumes:
            - ./api_gateway/src/:/zkit/
        networks:
            - frontend
        depends_on:
            - engine
            - avatar
            - redis
        restart: unless-stopped

    ### Engine service ###########################################
    engine:
        container_name: zkit_engine
        build:
            context: ./engine
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${ENGINE_APP_PORT}:8000"
        volumes:
            - ./engine/src/:/zkit/
        networks:
            - frontend
        depends_on:
            - postgres
        restart: unless-stopped

    ## Avatar #################################################
    avatar:
        container_name: zkit_avatar
        build:
            context: ./avatar
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
                - INSTALL_FFMPEG=${INSTALL_FFMPEG}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${AVATAR_APP_PORT}:8000"
        volumes:
            - ./avatar/src/:/zkit/
        networks:
            - frontend
        restart: unless-stopped

    ### ecommerce service #########################################
    ecommerce:
        container_name: zkit_ecommerce
        build:
            context: ./ecommerce
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${ECOMMERCE_APP_PORT}:8000"
        volumes:
            - ./ecommerce/src/:/zkit/
        networks:
            - frontend
        restart: unless-stopped

    ### multimedia service #########################################
    multimedia:
        container_name: zkit_multimedia
        build:
            context: ./multimedia
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${MULTIMEDIA_APP_PORT}:8000"
        volumes:
            - ./multimedia/src/:/zkit/
        networks:
            - frontend
        restart: unless-stopped

    ### content service ###########################################
    content:
        container_name: zkit_content
        build:
            context: ./content
            args:
                - PYTHON_VERSION=${PYTHON_VERSION}
        env_file:
            - .env
        command: ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug"]
        ports:
            - "${CONTENT_APP_PORT}:8000"
        volumes:
            - ./content/src/:/zkit/
        networks:
            - frontend
        depends_on:
            - mongo
        restart: unless-stopped

    ### Postgres DB #########################################
    postgres:
        container_name: zkit_postgres
        build:
            context: ./containers/postgres
            args:
                - POSTGRES_VERSION=${POSTGRES_VERSION}
        ## for develop
        command: postgres -c log_destination=stderr -c log_statement=all -c log_connections=on -c log_disconnections=on
        volumes:
            - ${DATA_PATH_HOST}/postgres:/var/lib/postgresql/data/
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-dbname}
            POSTGRES_USER: ${POSTGRES_USER:-username}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
            PGDATA: /var/lib/postgresql/data/
        ports:
            - "${POSTGRES_PORT}:5432"
        networks:
            - frontend
        depends_on:
            - pgadmin
        restart: unless-stopped

    ### mongo DB #########################################
    mongo:
        container_name: zkit_mongo
        build:
            context: ./containers/mongo
            args:
                - MONGO_VERSION=${MONGO_VERSION}
        restart: unless-stopped
        volumes:
            - ${DATA_PATH_HOST}/mongodb:/data/db
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
        ports:
            - ${MONGO_PORT}:27017
        networks:
            - frontend

    ### Redis ##############################################
    redis:
        container_name: zkit_redis
        build:
            context: ./containers/redis
            args:
                - REDIS_VERSION=${REDIS_VERSION}
        restart: unless-stopped
        command: redis-server --requirepass ${REDIS_PASSWORD}
        volumes:
            - ${DATA_PATH_HOST}/redis:/data
        ports:
            - ${REDIS_PORT}:6379
        networks:
            - frontend

    ## For developer
    ### pgAdmin ##############################################
    pgadmin:
        container_name: zkit_pgadmin
        build:
            context: ./containers/pgadmin
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-info@info.com}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-password}
        volumes:
            - ${DATA_PATH_HOST}/pgadmin:/root/.pgadmin
        ports:
            - "${PGADMIN_PORT:-5050}:80"
        networks:
            - frontend
        restart: unless-stopped

    ##
    kafka:
        image: obsidiandynamics/kafka
        container_name: zkit_kafka
        restart: "no"
        ports:
            - "2181:2181"
            - "9093:9093"
        environment:
            KAFKA_LISTENERS: "INTERNAL://:29092,EXTERNAL://:9093"
            KAFKA_ADVERTISED_LISTENERS: "INTERNAL://kafka:29092,EXTERNAL://localhost:9093"
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"
            KAFKA_INTER_BROKER_LISTENER_NAME: "INTERNAL"
            KAFKA_ZOOKEEPER_SESSION_TIMEOUT: "6000"
            KAFKA_RESTART_ATTEMPTS: "10"
            KAFKA_RESTART_DELAY: "5"
            ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: "0"
        healthcheck:
            test: nc -z localhost 29092 || exit
            interval: 10s
            timeout: 5s
            retries: 15
        networks:
            - frontend

    ##
    kafka-ui:
        image: provectuslabs/kafka-ui
        container_name: zkit_kafka_ui
        ports:
            - "7070:8080"
        restart: always
        environment:
            - KAFKA_CLUSTERS_0_NAME=local
            - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:29092
        networks:
            - frontend

volumes:
    postgres:
        driver: ${VOLUMES_DRIVER}
    pgadmin:
        driver: ${VOLUMES_DRIVER}
    mongo:
        driver: ${VOLUMES_DRIVER}
