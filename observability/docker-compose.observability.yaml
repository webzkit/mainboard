x-logging: &default-logging
    driver: loki
    options:
        loki-url: "http://localhost:3100/api/prom/push"
        loki-pipeline-stages: |
            - multiline:
                firstline: '^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2}'
                max_wait_time: 3s
            - regex:
                expression: '^(?P<time>\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2},\d{3}) (?P<message>(?s:.*))$$'

services:
    loki:
        image: grafana/loki:3.5.0

        # for prod
        #volumes:
        #    - ./etc/loki/loki-config.yaml:/etc/loki/local-config.yaml
        #    - ${DATA_PATH_HOST}/loki/data:/loki
        command: -config.file=/etc/loki/local-config.yaml
        ports:
            - "3100:3100"
        networks:
            - zkit_network
        #depends_on:
        #    minio:
        #        condition: service_healthy
        #    create-bucket:
        #        condition: service_completed_successfully

    #minio:
    #    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    #    ports:
    #        - 9000:9000
    #        - 9001:9001
    #    user: "0:0"
    #    volumes:
    #        - ${DATA_PATH_HOST}/minio/data:/data
    #    environment:
    #        - MINIO_ROOT_USER=admin
    #        - MINIO_ROOT_PASSWORD=password
    #    command: server /data --console-address ":9001"
    #    healthcheck:
    #        test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    #        interval: 5s
    #        timeout: 5s
    #        retries: 5
    #    networks:
    #        - zkit_network

    #create-bucket:
    #    image: minio/mc:RELEASE.2025-02-04T04-57-50Z
    #    depends_on:
    #        - minio
    #    networks:
    #        - zkit_network
    #    entrypoint: >
    #        /bin/sh -c "
    #        sleep 10;
    #        mc alias set local http://minio:9000 admin password;
    #        mc mb local/loki;
    #        mc anonymous set public local/loki;
    #        exit 0;
    #        "

    prometheus:
        image: prom/prometheus:v3.3.1
        ports:
            - "9090:9090"
        volumes:
            - ./etc/prometheus:/workspace
        command:
            - --config.file=/workspace/prometheus.yml
            - --enable-feature=exemplar-storage
        depends_on:
            - loki
        networks:
            - zkit_network
        logging: *default-logging

    tempo:
        image: grafana/tempo:2.7.2
        command:
            [
                "-config.file=/etc/tempo.yml",
                "--target=all",
                "--storage.trace.backend=local",
                "--storage.trace.local.path=/var/tempo",
                "--auth.enabled=false",
            ]
        ports:
            - "4317:4317"
            - "4318:4318"
        volumes:
            - ./etc/tempo/tempo.yml:/etc/tempo.yml
        depends_on:
            - loki
        networks:
            - zkit_network
        logging: *default-logging

    grafana:
        image: grafana/grafana:12.0.0
        ports:
            - "3000:3000"
        volumes:
            - ./etc/grafana/:/etc/grafana/provisioning/datasources
            - ./etc/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml
            - ./etc/dashboards:/etc/grafana/dashboards
        depends_on:
            - loki
            - prometheus
        networks:
            - zkit_network
        logging: *default-logging

volumes:
    loki:
    minio:
    grafana:
    tempo:
    prometheus:

networks:
    zkit_network:
        external: true
